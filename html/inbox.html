<ul class="inbox">



  <!--
  <li class="negotiation unread">
    <i class="fa fa-money"></i>
    <h3>Counter-Offer Received</h3>
    <p>Bob's Bait &amp; Tackle Emporium</p>
    <p class="date">4 hours ago</p>
  </li>
  <li class="change-order unread">
    <i class="fa fa-exchange"></i>
    <h3>Change Order Request</h3>
    <p>Nike</p>
    <p class="date">8 hours ago</p>
  </li>
  <li class="under-serving unread">
    <i class="fa fa-heartbeat"></i>
    <h3>Under-Serving</h3>
    <p>K-Mart</p>
    <p class="date">9 hours ago</p>
  </li>

  <li class="under-serving">
    <i class="fa fa-heartbeat"></i>
    <h3>Under-Serving</h3>
    <p>K-Mart</p>
    <p class="date">1 day ago</p>
  </li>
  <li class="under-serving">
    <i class="fa fa-heartbeat"></i>
    <h3>Under-Serving</h3>
    <p>K-Mart</p>
    <p class="date">1 day ago</p>
  </li>
  -->
</ul>

<script>
  var inboxData = [
    {
      type: 'under-serving',
      unread: true,
      name: 'K-Mart',
      date: '30 seconds ago'
    },
    {
      type: 'under-serving',
      unread: true,
      name: 'K-Mart',
      date: '30 seconds ago'
    }
  ];

  function inboxTemplate(item) {
    var rv = "";
    var icon = '';
    var heading = '';
    var unread = (readList.indexOf(''+item.id) === -1);
    switch (item.type) {
      case 'under-serving':
        icon = 'heartbeat';
        heading = "Campaign Under-Serving";
      break;
      case 'counter-offer':
        icon = 'money';
        heading = "Counter-Offer Received";
      break;
    }
    rv += "<li class=\""+item.type+" "+(unread?'unread':'')+"\" data-id=\""+item.id+"\" data-url=\""+item.url+"\">";
    rv += "  <i class=\"fa fa-"+icon+"\"></i>";
    rv += "  <h3>"+heading+"</h3>";
    rv += "  <p>"+item.name+"</p>";
    //rv += "  <p class=\"date\">"+item.date+"</p>";
    rv += "</li>";
    return rv;
  };

  function processTemplate(templateFunction, data) {
    var rv = '';
    for (var x=0; x<data.length; x++) {
      rv += templateFunction(data[x]);
    }
    return rv;
  };

  var readList = [];
  pollInbox = true;
  function poll() {
    $.ajax({
      dataType: "json",
      url: './mock2.json',
      success: function(data) {
        $('.inbox').html(processTemplate(inboxTemplate, rawDataToInboxData(data)));
        $('.inbox li').click(function(e) {
          openBrowser($(e.currentTarget).attr('data-url'));
          markRead(e.currentTarget);
        });
        if (pollInbox) setTimeout(poll, 500);
      },
      error: function() {
      }
    });
  };
  poll();

  function markRead(node) {
    node = $(node);
    readList.push(node.attr('data-id'));
    node.removeClass('unread');
  };

  function rawDataToInboxData(rawData) {
    var rv = [];
    var xyzzy = 0;
    for (var x=0; x<rawData.rows.length; x++) {
      rv.push({
        id: xyzzy++,
        type: 'under-serving',
        name: rawData.rows[x].propertyName,
        date: '30 seconds ago',
        url: rawData.rows[x].url
      });
    }
    return rv;
  };
</script>